<!DOCTYPE html>
<!--
    Chris Delpire and Austin Heiman ChatBucket UI HTML.
    7/14/2014
    v0.2
-->
<html>

<head>
<title>chatHub</title>
<link rel="icon" type="image/png" href="/chatHubIcon.png" />
<link rel="stylesheet" href="./octicons/octicons.css">
<style>
html,body {
    height:100%;
    margin:0px;
    min-width:750px;
    overflow-y:auto;
    min-height:300px;
    font-size:100%;
    font-family:"arial";
    background-color:#eee;
    color:#111;
}
div.card {
  background-color:#fff;
  padding: 3px 3px;
  border-style: solid;
  border-radius: 3px;
  border-width: 1px;
  border-color: #bbb;
  -webkit-box-shadow: 3px 3px 6px -3px #999;
  -moz-box-shadow: 3px 3px 6px -3px #999;
  box-shadow: 3px 3px 6px -3px #999;
  /* h-shadow v-shadow blur spread color */
}
div.populationCard {
	height:145px;
	overflow:auto;
}
input , textarea {
  border:1px solid #bbb;
}
.column {
    float:left;
    margin:0px;
    border:0px;
    padding:0px;
    height:100%;
}
#leftColumn {
    width:calc(100% - 250px);
}
.column div {
    margin:6px;
    /*border:1px solid black;*/
    padding:6px;
}
#chatBoxDiv {
    height:calc(100% - 114px);
    overflow-y:auto;
}
#chatBoxDiv p.messageP {
    margin:0px;
    border:0px;
    padding:0px;
    margin-bottom:5px;
}
.messageInfoSpan {
    color:gray;
    width:500px;
}
#messageTextarea {
    width:calc(100% - 6px);
    margin:0px;
    resize:none;
    font-family:arial;
}
#popupBackgroundDiv{
    display:none;
    z-index:200;
    height:100%;
    width:100%;
    position:absolute;
    background-color:#000;
    opacity:.5;    /*opacity:1; is no seethru*/
}
#popupSettingsDiv {
    display:none;
    padding: 20px;
    position:absolute;
    background-color:white;
    z-index:300;
    height:70%;
    width:45%;
    min-height:250px;
    overflow-y:auto;
}
/*#youtubeBucket {*/
/*	display:none;*/
/*	position:absolute;*/
/*	top:25px;*/
/*	z-index:200;*/
/*	height:360px;*/
/*	width:640px;*/
/*	left:calc(100% - 916px);*/
/*	border:1px solid black;*/
/*}*/
#rightColumn {
    width:250px;
    overflow-y:auto;
}
#rightColumn div {
    margin-left:0px;
}
#roomMembersUL,#roomsList {
    margin: 6px 0px 0px 12px;
    border:0px;
    padding:0px;
}
#roomSearchInput {
    width:calc(100% - 4px);
}

.pointer { cursor:pointer; }
.center {text-align:center;}
.large {font-size:115%;}
.bold {font-weight:bold;}
.Absolute-Center {
    margin: auto;
    position: absolute;
    top: 0; left: 0; bottom: 0; right: 0;
}
h1 , h2 , h3 , h4 {
    padding:0px;
    margin:0px;
}
/*li.noBullet {*/
/*  list-style-type: none;*/
/*}*/
li {
  list-style-type:none;
}
li.room {
  padding:2px 6px;
  border-radius:5px;
  transition: background-color .5s;
  line-height:140%;
}
li.unselectedRoom {
  cursor:pointer;
}
li.unselectedRoom:hover {
  background-color:#f2f2f2;
}
li.selectedRoom {
  background-color:#3399ff;
  color:#ffffff;
  cursor:default;
}
.chatBoxNotification {
   color:#666;
   text-align: center;
   font-size:75%;
   margin:0px;
}
.inline { display:inline; }
.right { float:right; }
.large { font-size:115%; }
.larger { font-size:130%; }
.largest { font-size:145%; }
.small { font-size:85%; }
.smaller { font-size:70%; }
.smallest { font-size:65%; }
.red { font-color:#600; }
.block { display:block; }
.gray { color:#888; }
.black { color:#000; }
hr.fadeout {
    margin-top:5px;
    margin-bottom:5px;
    border: 0;
    height: 1px;
    background-image: -webkit-linear-gradient(left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.90), rgba(0, 0, 0, 0));
    background-image: -moz-linear-gradient(left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.90), rgba(0, 0, 0, 0));
    background-image: -ms-linear-gradient(left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.90), rgba(0, 0, 0, 0));
    background-image: -o-linear-gradient(left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.90), rgba(0, 0, 0, 0));
}
#bucketSpan {
  position:absolute;
  top:13px;
  right:263px;
}
#bucketXSpan {
  position:absolute;
  top:13px;
  right:263px;
  color:red;
  display:none;
}
#youtubeiFrame {
  position:absolute;
  top:13px;
  right:285px;
  height:0px;
  width:0px;
  transition: width 1s, height 1s;
  display:none;
  /*background-color:orange;*/
}
@-webkit-keyframes dance {
  0% {
    transform:rotate(0deg);
    -ms-transform:rotate(0deg);
    -webkit-transform:rotate(0deg);
  }
  20% {
    transform:rotate(0deg);
    -ms-transform:rotate(0deg);
    -webkit-transform:rotate(0deg);
  }
  30% {
    transform:rotate(30deg);
    -ms-transform:rotate(30deg);
    -webkit-transform:rotate(30deg);
  }
  70% {
    transform:rotate(-30deg);
    -ms-transform:rotate(-30deg);
    -webkit-transform:rotate(-30deg);
  }
  80% {
    transform:rotate(0deg);
    -ms-transform:rotate(0deg);
    -webkit-transform:rotate(0deg);
  }
  100% {
    transform:rotate(0deg);
    -ms-transform:rotate(0deg);
    -webkit-transform:rotate(0deg);
  }
}
.dance {
    /* Chrome, Safari, Opera */
    -webkit-animation-name: dance;
    -webkit-animation-duration: 1.5s;
    -webkit-animation-timing-function: linear;
    -webkit-animation-delay: 0s;
    -webkit-animation-iteration-count: infinite;
    -webkit-animation-direction: alternate;
    -webkit-animation-play-state: running;
    /* Standard syntax */
    animation-name: dance;
    animation-duration: 1s;
    animation-timing-function: linear;
    animation-delay: 0s;
    animation-iteration-count: infinite;
    animation-direction: alternate;
    animation-play-state: running;
}



</style>
</head>

<body id='myBody' onload="main()">

<!--<div id='youtubeBucket' class="card">-->

<!--</div>-->

<div id='popupBackgroundDiv' onclick='closePopups()'></div>
<div id='popupSettingsDiv' class='Absolute-Center card'>
    <h2 class='center'>Settings</h2>
    <hr class="fadeout">
    <p> <!-- UI Settings -->
        <label>UI Theme: </label>
        <select id='themeSelect'>
            <option>Light</option>
            <option>Dark</option>
        </select><br>
        <input type="checkbox" id='incomingColorsCheck'><label> Ignore incoming message colors </label><br>
        <input type="checkbox" id='incomingFontCheck'><label> Ignore incoming message fonts </label>
    </p>
    <p> <!-- Rooms Settings -->
        <label>Default Room: </label>
        <select id='defaultRoomSelect'>
            <option>Default Room</option>
            <option>Last Room</option>
        </select>
    </p>
    <button id='saveSettingsButton' onclick='saveSettings()'>Save Settings</button>
</div>

<!--<div id='bucketDiv' style='background-color:lightgray;'>-->
  <iframe id='youtubeiFrame' width="320" height="180" src="" frameborder="0" allowfullscreen></iframe>
	<span id="bucketSpan" class="octicon octicon-paintcan right larger pointer block gray" onclick='sendBucket()'></span>
	<span id="bucketXSpan" class="octicon octicon-x right larger pointer" onclick="collapseBucketDiv()"></span>
<!--</div>-->

<div id='leftColumn' class='column'>
  <div id='chatBoxDiv' class='card'>
	<p style='margin:0px 0px 5px 0px;'>Welcome to chatHub, our lightweight, free chat service!</p>
	<p style='margin:0px 0px 6px 0px;'>Just begin typing...</p>
    </div>

    <div id='sendMessageDiv' class='card'>
        <textarea id='messageTextarea' rows='2' placeholder='Send a message...' onkeypress="checkEnterButton(event)" autofocus></textarea>
        <select id='fontSelect' onchange='fontFamilyChange()'>
            <option value='arial'>Arial</option>
            <option value='monospace'>Monospace</option>
        </select>
        <select id='colorSelect' onchange='fontColorChange()'>
            <option value='#000000'>Black</option>
            <option value='#0000ff'>Blue</option>
            <option value='#00ccff'>Cyan</option>
            <option value='#ff0000'>Red</option>
            <option value='#33cc33'>Green</option>
            <option value='#ffffff'>White</option>
            <option value='#ffff00'>Yellow</option>
            <option value='#ffa71a'>Day[9] Yellow</option>
            <option value='#512888'>EMAW</option>
            <option value='#ff9900'>Caret</option>
            <option value='#93BF72'>Oscar Green</option>
        </select>
        <button id='sendButton' class="right" onclick="sendMessage()">Send</button>
    </div>
</div>

<div id='rightColumn' class='column'>
    <div id='settingsDiv' class='card'>
        <label for='usernameInput'>Username: </label><input type='text' id='usernameInput' value='anonymous' size='13' maxlength='18' onchange="nameOnBlur();"><span class="octicon octicon-gear right larger pointer" onclick='displaySettings()' style="padding-top:1px;"></span>
    </div>
    <div id='roomMembersDiv' class='card populationCard'>
        Users in "DefaultLobby"
	<hr class="fadeout">
	<ul id='roomMembersUL'>
	</ul>
    </div>
    <div id='roomsListDiv' class='card'>
        <input type='text' id='roomSearchInput' placeholder='Create a room...' onkeypress="checkEnterRoom(event)"><br>
        <p style="margin:3px 0px;">Available Rooms:</p>
		<hr class="fadeout">
        <ul id='roomsList'>
			<li id='DefaultLobby' class='inline room selectedRoom' onclick='selectRoom(this)'>DefaultLobby</li><br>
            <li id='Automations' class='inline room unselectedRoom' onclick='selectRoom(this)'>Automations</li><br>
            <li id='Java' class='inline room unselectedRoom' onclick='selectRoom(this)'>Java</li><br>
            <li id='TV' class='inline room unselectedRoom' onclick='selectRoom(this)'>TV</li><br>
            <li id='Rick and Morty' class='inline room unselectedRoom' onclick='selectRoom(this)'>Rick and Morty</li><br>
            <li id='Misc' class='inline room unselectedRoom' onclick='selectRoom(this)'>Misc</li><br>
        </ul>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script src="/functions.js"></script>
<script>

socket = io();
usernames = {};
selectedRoom = "DefaultLobby";
isBlurred = false;
numberOfMissedMessages = 0;

function initiateGlobals() {
    usernameInput = document.getElementById("usernameInput");
    myUsername = usernameInput.value;
    messageTextarea = document.getElementById("messageTextarea");
    chatBoxDiv = document.getElementById("chatBoxDiv");
    myRoom = "default room set globally";
    fontSelect = document.getElementById('fontSelect');
    colorSelect = document.getElementById('colorSelect');
    myFont = fontSelect.value;
    myColor = fontSelect.value;
    previousMessage = "";
    previousUsername = usernameInput.value;
    isNewToRoom = true;
    popupBackgroundDiv = document.getElementById('popupBackgroundDiv');
    popupSettingsDiv = document.getElementById('popupSettingsDiv');
    defaultRoomInput = document.getElementById('defaultRoomInput');
    defaultRoomSelect = document.getElementById('defaultRoomSelect');
  	roomMembersDiv = document.getElementById('roomMembersDiv');
    themeSelect = document.getElementById('themeSelect');
    incomingColorsCheck = document.getElementById('incomingColorsCheck');
    incomingFontCheck = document.getElementById('incomingFontCheck');
    roomSearchInput = document.getElementById('roomSearchInput');
    roomsList = document.getElementById('roomsList');
// 	youtubeBucket = document.getElementById('youtubeBucket');
	youtubeiFrame = document.getElementById('youtubeiFrame');
// 	bucketDiv = document.getElementById('bucketDiv');
	bucket = {};
	bucketSpan = document.getElementById('bucketSpan');
	bucketXSpan = document.getElementById('bucketXSpan');
    
    // load settings from localStorage if existing
    if (localStorage.getItem("settingsJSON") !== null) {
      mySettings = JSON.parse(localStorage.settingsJSON);
      console.log('loading localStorage settings into mySettings...');
    } else {
      mySettings = {};
      console.log('no localStorage settings found, intializing mySettings');
    }
    configureSettings()
    console.log("settings loaded:");
    console.log(mySettings);

    popupBackgroundDiv = document.getElementById('popupBackgroundDiv');
    popupSettingsDiv = document.getElementById('popupSettingsDiv');
	window.onfocus = onFocus;
	window.onblur = onBlur;
}

function main() {
    initiateGlobals();
    usernameInput.value = generateRandUsername();
	previousUsername = myUsername;
	
}

function sendBucket(){
	socket.emit('send bucket', { type:"youtube", src:"//www.youtube.com/embed/TX8IjeWdxKs" } );
}

function onBlur() {
	isBlurred = true;
};

function onFocus() {
	isBlurred = false;
	numberOfMissedMessages = 0;
	var title = document.getElementsByTagName("title");
	title[0].innerHTML = "chatHub";
};

function displaySettings() {
  popupBackgroundDiv.style.display = "block";
  popupSettingsDiv.style.display = "block";
  }
  
function selectRoom(element) {

	if(selectedRoom == element.innerHTML)
		return;
		
	closeBucket();
	
	var last = document.getElementById(selectedRoom);
	last.className = "inline room unselectedRoom";
	
	socket.emit('left room');
	chatBoxDiv.innerHTML += "<hr class='fadeout'>";
	
	element.className = "inline room selectedRoom";
	selectedRoom = element.innerHTML;

	roomMembersUL.innerHTML = ""
	
	usernames = socket.emit('request join room', selectedRoom);
}

function alphanumericUnderDash(string) {
  // leave only alphanumeric, dashes, underscores
  string = string.replace(/[^a-zA-Z0-9-_]/g,"");
  return string;
}

function alphanumericUnderDashSpace(string) {
  // leave only alphanumeric, dashes, underscores
  string = string.replace(/[^a-zA-Z0-9-_\s]/g,"");
  return string;
}
	
function closePopups() {
  popupBackgroundDiv.style.display = "none";
  popupSettingsDiv.style.display = "none";
}

function saveSettings() {
  // save all settings to mySettings object
  //mySettings.theme
  //mySettings.ignoreColors = incomingColorsCheck
  //mySettings.ignoreFont = incomingFontCheck.checked
  localStorage.settingsJSON = JSON.stringify(mySettings);
  closePopups();
  
  }
function checkEnterButton(e) {

    var key = e.keyCode ? e.keyCode : e.which;

    if (key == 13 && !e.shiftKey && document.activeElement === messageTextarea) {
        sendMessage();
        e.preventDefault();
    }
}

function expandBucket(width,height) {
  expandYoutubeiFrame(width,height);
  bucketSpan.style.display = "none";
  bucketXSpan.style.display = "inline";
  bucket.expanded = true;
  bucketNotification("off");
}

function expandYoutubeiFrame(width,height) {
  youtubeiFrame.style.display = "inline";
  setTimeout(function(){youtubeiFrame.style.width = width;},100);
  setTimeout(function(){youtubeiFrame.style.height = height;},100);
}

function collapseBucketDiv() {
  youtubeiFrame.style.width = "0px";
  youtubeiFrame.style.height = "0px";
  bucketXSpan.style.display = "none";
  bucketSpan.style.display = "inline";
  bucket.expanded = false;
}

function bucketNotification(onOrOff) {
  if (onOrOff == "on") {
    bucketSpan.class = "octicon octicon-paintcan right larger pointer block black dance";
  }
  if (onOrOff == "off") {
    bucketSpan.class = "octicon octicon-paintcan right larger pointer block gray";
  }
}

// function checkEnterUsername(e){

// 	var key = e.keyCode ? e.keyCode : e.which;
	
// 	if(key == 13) {
// 		usernameInput.blur();
// 	}
// }

function checkEnterRoom(e){
	
	var key = e.keyCode ? e.keyCode : e.which;
	
	if(key == 13) {
		// var input = document.getElementById('roomSearchInput');
		// var roomsList = document.getElementById('roomsList');
		var newRoom = alphanumericUnderDashSpace(roomSearchInput.value);
		roomSearchInput.blur();
		roomsList.innerHTML = roomsList.innerHTML + "<li id='" + newRoom + "' class='inline room unselectedRoom' onclick='selectRoom(this)'>" + newRoom + "</li><br>";
		var room = document.getElementById(newRoom);
		selectRoom(room);
		roomSearchInput.value = "";
		messageTextarea.focus();
	}
}

function configureSettings() {
  // set the settings saved from mySettings obj
  }
  
function displayNone(element) {
    element.style.display = 'none';
}

function buildMessageObject() {
    var myContents = messageTextarea.value;
    previousMessage = myContents;
    myContents = fontEffectReplace(cleanInput(myContents));
    var myTime = getTime();
    myUsername = alphanumericUnderDash(myUsername);
    var messageObj = {room:selectedRoom , font:myFont , time:myTime ,
        color:myColor , username:myUsername , contents:myContents} ;
    console.log("sending message:");
    console.log(messageObj);
    return messageObj;
}

function fontColorChange() {
    myColor = colorSelect.value;
    messageTextarea.style.color = myColor;
}

function fontFamilyChange() {
    myFont = fontSelect.value;
    messageTextarea.style.fontFamily = myFont;
}

function nameOnBlur() {
	myUsername = alphanumericUnderDash(usernameInput.value);
	if(myUsername != previousUsername && myUsername != ""){
	  
			socket.emit('username changed', myUsername);
			previousUsername = myUsername;
			usernameInput.value = myUsername;
		}

}

function closeBucket(){
	youtubeiFrame.src="";
	collapseBucketDiv();
}

function sendMessage() {
  if (messageTextarea.value === "" ) {
    messageTextarea.focus();
    return false;
}
		
	var messageObj = buildMessageObject();
	socket.emit('chat message', messageObj);
	messageTextarea.value = "";
	messageTextarea.focus();
}

	socket.on('chat message', function(messageObj) {
	    console.log("message received:");
	    console.log(messageObj);
		
		if(isBlurred){
			numberOfMissedMessages++;
			var title = document.getElementsByTagName("title");
			title[0].innerHTML = "(" + numberOfMissedMessages + ") chatHub";
		}
		
		var messageString = "<p class='messageP' style='color:" + messageObj.color + ";font-family:" + messageObj.font + ";'><span class='messageInfoSpan'>[" + messageObj.username + " " + messageObj.time + "]</span> " + messageObj.contents + "</p>";
			
			chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + messageString;
			chatBoxDiv.scrollTop = chatBoxDiv.scrollHeight;
		});
		
	socket.on('request username', function(msg) {
		socket.emit('receive username', usernameInput.value);
	});
		
	socket.on('join room', function(joinObj){
	
		usernames = joinObj.usernames;
		
		roomMembersDiv.innerHTML = 'Users in "' + selectedRoom + '"<hr class="fadeout"><ul id="roomMembersUL"></ul>';
		
		for(var key in usernames){
			if(usernames.hasOwnProperty(key)){
				var listItem = document.getElementById(key);
		
				if(listItem == null)
					roomMembersUL.innerHTML = roomMembersUL.innerHTML + "<li id='" + key + "' class='noBullet'>" + usernames[key]  + "</li>";
			}
		}
		
		chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + "<p class='chatBoxNotification'>" +  joinObj.username + " has joined the room.</p>";
		chatBoxDiv.scrollTop = chatBoxDiv.scrollHeight;
	});
	
	socket.on('play video', function(link) {
	  expandBucket("320px","180px");
		youtubeiFrame.src=link;
	});
	
	socket.on('changed name', function(joinObj){
	
		var oldName = usernames[joinObj.id];
		usernames[joinObj.id] = joinObj.username;
		
		chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + "<p class='chatBoxNotification'>" + oldName + " has changed their name to " + joinObj.username + ".</p>";
		var listItem = document.getElementById(joinObj.id);
		listItem.innerHTML = joinObj.username;

	});
	
	socket.on('disconnected', function(userId){
		
		var name = usernames[userId];
		
		if(name == null)
			name = myUsername;
		else{
			delete usernames[userId];
			var node = document.getElementById(userId);
			node.parentNode.removeChild(node);
		}
			
		chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + "<p class='chatBoxNotification'>" + name+ " has left the room.</p>";
	});

function cleanInput(input) {
    input = input.replace(/(<([^>]+)>)/ig,"");
    input = input.replace(/\n/g,"<br />");
    return input;
}

function fontEffectReplace(input) {
    input = input.replace( /\*\*(.+?)\*\*/gm, "<b>$1</b>" );
    input = input.replace( /\_\_(.+?)\_\_/gm, "<u>$1</u>" );
    input = input.replace( /\*(.+?)\*/gm, "<i>$1</i>" );
    return input;
}

function getTime() {
    var date = new Date();
    var hour = date.getHours();
    var ampm = "am";
    
    if(hour > 12) {
        hour = hour - 12;
        ampm = "pm";
    }
    else if(hour == 12)
        ampm = "pm";
    else if(hour == 0)
        hour = 12;
    
    var minutes = date.getMinutes();
    if (minutes < 10 ) {
        minutes = "0" + minutes ;
    }
    
    return hour + ":" + minutes + ampm;
}

function generateRandUsername() {
    var adj = generateAdj();
    var noun = generateNoun();
    myUsername = adj + noun;
    return myUsername;
}

</script>

</body>

</html>

