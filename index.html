<!DOCTYPE html>
<!--
  Chris Delpire and Austin Heiman ChatBucket UI HTML.
  7/14/2014
  v0.2
-->
<html>

<head>
<title>Chat v2</title>
<link rel="stylesheet" href="./octicons/octicons.css">
<style>
html,body {
  height:100%;
  margin:0px;
  min-width:750px;
  overflow-y:auto;
  min-height:300px;
  font-size:100%;
  font-family:arial;
  background-color:#eee;
}
.column {
  float:left;
  margin:0px;
  border:0px;
  padding:0px;
  height:100%;
}
#leftColumn {
  width:calc(100% - 250px);
}
.column div {
  margin:6px;
  border:1px solid black;
  padding:6px;
}
#chatBoxDiv {
  height:calc(100% - 114px);
  overflow-y:scroll;
}
#chatBoxDiv p {
  margin:0px;
  border:0px;
  padding:0px;
  margin-bottom:5px;
}
.messageInfoSpan {
  color:gray;
  width:500px;
}
#messageTextarea {
  width:calc(100% - 6px);
  margin:0px;
  border:1px solid black;
  resize:none;
  font-family:arial;
}
#rightColumn {
  width:250px;
  overflow-y:auto;
}
#rightColumn div {
  margin-left:0px;
}
#roomMembersP,#roomsList {
  margin: 6px 0px 0px 12px;
  border:0px;
  padding:0px;
}
#roomSearchInput {
  width:calc(100% - 4px);
}
</style>
</head>

<body id='myBody' onload="main()">
<div id='leftColumn' class='column'>
  <div id='chatBoxDiv'>
    <p class='messageP'><span class='messageInfoSpan'>[Austin 8:58am] </span>This green is awesome! We need color and the buttons/options related to the message sending can go below it.</p>
  </div>
  <div id='sendMessageDiv'>
    <textarea id='messageTextarea' rows='2' placeholder='Send a message...' onkeypress="checkEnterButton()" autofocus></textarea>
    <select id='fontSelect' onchange='fontFamilyChange()'>
      <option value='arial'>Arial</option>
      <option value='monospace'>Monospace</option>
    </select>
    <select id='colorSelect' onchange='fontColorChange()'>
      <option value='#000000'>Black</option>
      <option value='#0000ff'>Blue</option>
      <option value='#00ccff'>Cyan</option>
      <option value='#ff0000'>Red</option>
      <option value='#33cc33'>Green</option>
      <option value='#ffffff'>White</option>
      <option value='#ffff00'>Yellow</option>
      <option value='#ffa71a'>Day[9] Yellow</option>
      <option value='#512888'>EMAW</option>
      <option value='#ff9900'>Caret</option>
      <option value='#93BF72'>Oscar Green</option>
    </select>
    <button id='sendButton' onclick="sendMessage()">Send</button>
  </div>
</div>

<div id='rightColumn' class='column'>
  <div id='settingsDiv'>
    <label for='usernameInput'>Username: </label><input type='text' id='usernameInput' value='anonymous' size='12' maxlength='18'><span class="octicon octicon-gear"></span>
  </div>
  <div id='roomMembersDiv'>
    Currently in "Default Room"
    <p id='roomMembersP'>
      Austin<br>
      Chris<br>
    </p>
  </div>
  <div id='roomsListDiv'>
    <input type='text' id='roomSearchInput' placeholder='Search for a room...'><br>
    Recent rooms:
    <p id='roomsList'>
      Java<br>
      WebDev<br>
      Automation<br>
      ECA<br>
      CTS Architects<br>
    </p>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script>

	socket = io();

  function initiateGlobals() {
    usernameInput = document.getElementById("usernameInput");
    myUsername = usernameInput.value;
    messageTextarea = document.getElementById("messageTextarea");
    chatBoxDiv = document.getElementById("chatBoxDiv");
    myRoom = "default room set globally";
    fontSelect = document.getElementById('fontSelect');
    colorSelect = document.getElementById('colorSelect');
    myFont = fontSelect.value;
    myColor = fontSelect.value;
    previousMessage = "";
    isNewToRoom = true;
  }
  
	function main() {
	  initiateGlobals();
		usernameInput.value = generateRandUsername();
	}

	function checkEnterButton() {
		var evnt = window.event;
		var key = evnt.keyCode;

		if (key == 13 && !evnt.shiftKey && document.activeElement === messageTextarea) {
			sendMessage();
			evnt.preventDefault();
		}
	}
  
  function buildMessageObject() {
    var myContents = messageTextarea.value;
    previousMessage = myContents;
    myContents = cleanInput(myContents);
    var myTime = getTime();
    myUsername = cleanInput(myUsername);
    var messageObj = {room:myRoom , font:myFont , time:myTime ,
      color:myColor , username:myUsername , contents:myContents} ;
    console.log("sending message:");
    console.log(messageObj);
    return messageObj;
  }

function fontColorChange() {
  myColor = colorSelect.value;
  messageTextarea.style.color = myColor;
}

function fontFamilyChange() {
  myFont = fontSelect.value;
  messageTextarea.style.fontFamily = myFont;
}

	function sendMessage() {
		var messageObj = buildMessageObject();
		socket.emit('chat message', messageObj);
		messageTextarea.value = "";
	}
	
	socket.on('chat message', function(messageObj) {
	    console.log("message received:");
	    console.log(messageObj);
		  var messageString = "<p class='messageP' style='color:" + messageObj.color + ";font-family:" + messageObj.font + ";'><span class='messageInfoSpan'>[" + messageObj.username + " " + messageObj.time + "]</span> " + messageObj.contents + "</p>";
			
			chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + messageString;
			chatBoxDiv.scrollTop = chatBoxDiv.scrollHeight;
		});
		
		socket.on('whoareyou', function(msg) {
      if (isNewToRoom) {
		    socket.emit('iam', usernameInput.value);
      }
      isNewToRoom = false;
		});
		
		socket.on('joinedroom', function(msg){
		  chatBoxDiv.innerHTML = chatBoxDiv.innerHTML + msg + "<br>";
		  chatBoxDiv.scrollTop = chatBoxDiv.scrollHeight;
		});
		
	function cleanInput(input) {
	  input = input.replace(/(<([^>]+)>)/ig,"");
		input = input.replace(/\n/g,"<br />");
		input = input.replace( /\*\*(.+?)\*\*/gm, "<b>$1</b>" );
		input = input.replace( /\_\_(.+?)\_\_/gm, "<u>$1</u>" );
		input = input.replace( /\*(.+?)\*/gm, "<i>$1</i>" );
		return input;
	}
	
	function getTime() {
	
		var date = new Date();
		var hour = date.getHours();
		var ampm = "am";
		
		if(hour > 12) {
			hour = hour - 12;
			ampm = "pm";
		}
		else if(hour == 12)
			ampm = "pm";
		else if(hour == 0)
			hour = 12;
		
		var minutes = date.getMinutes();
    if (minutes < 10 ) {
      minutes = "0" + minutes ;
    }
		
		return hour + ":" + minutes + ampm;
	}
	
	function generateNoun() {
		var nounArray = [ "Cat",
		  "Dog",
		  "Monkey",
		  "Cow",
		  "Moose",
		  "Chicken",
		  "Platypus",
		  "Mango",
		  "Pirate",
		  "Wizard",
		  "Knight",
		  "Box"	  ];
		  
		var noun = nounArray[Math.floor(Math.random() * nounArray.length)];
		  
		return noun;
	}
  
	function generateAdj() {
		var adjectiveArray = [ "Blue",
		  "Red",
		  "Metal",
		  "Angry",
		  "Feisty",
		  "Sad",
		  "Hungry",
		  "Mellow",
		  "Happy",
		  "Erect",
		  "Aroused",
		  "Deliberate",
		  "Frenzied" ];
		  
		var adj = adjectiveArray[Math.floor(Math.random() * adjectiveArray.length)];
		  
		return adj;
    }

	function generateRandUsername() {
		var adj = generateAdj();
		var noun = generateNoun();
                myUsername = adj + noun;
		return myUsername;
	}


</script>

</body>

</html>
